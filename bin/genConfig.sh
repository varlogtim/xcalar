#!/bin/bash

NumVirtualNodesPerPhysicalNode="${NumVirtualNodesPerPhysicalNode:-1}"
StartPort=5000
StartApiPort=18552
StartMonPort=8000

### Do not edit below this line ###
if [ $# -lt 2 ]; then
    echo "Usage $0 [inputCfg] [outputCfg] <node0> ..."
    exit
fi

virt_what () {
    local output=
    if [ "$container" = "docker" ]; then
        echo $container
        return 0
    elif output="$(/usr/bin/sudo -n virt-what 2>/dev/null)"; then
        if [ "$output" != "" ]; then
            echo $output
            return 0
        fi
    elif output="$(/opt/puppetlabs/bin/facter -p virtual 2>/dev/null)"; then
        if [ "$output" != "physical" ] && [ "$output" != "" ]; then
            echo $output
            return 0
        fi
    fi
    return 1
}


inputCfg=$1
outputCfg=$2

shift 2
NumPhysicalNodes=$#
ii=0
while [ $# -gt 0 ]; do
    PhysicalNodesIpAddr[$ii]="$1"
    ii=$(( $ii + 1 ))
    shift
done

if [ "$inputCfg" = '-' ]; then
    inputCfg=/dev/stdin
elif [ ! -e "$inputCfg" ]; then
    echo "$inputCfg does not exist!"
    exit 1
fi

if [ "$outputCfg" = '-' ]; then
    outputCfg=/dev/stdout
elif [ -e "$outputCfg" ] && [ -t 0 ]; then
    echo -n "$outputCfg already exists. Overwrite? [y/N] "
    read r
    if [ "$r" = "y" -o "$r" = "Y" ]; then
        rm $outputCfg

    else
        echo "Skipping $outputCfg" >&2
        exit
    fi
fi

TotalNodes=$(($NumPhysicalNodes * $NumVirtualNodesPerPhysicalNode))

Output=""
while read line; do
    echo "$line" | grep -q "// --- Start of auto-generated stuff ---"
    keepGoing=$?
    Output+="$line\n"
    if [ "$keepGoing" = "0" ]; then
        break
    fi
done < $inputCfg

Output+="// Cluster management stuff. The following has been\n"
Output+="// auto-generated by genConfig.sh\n"

if virt_used="$(virt_what)"; then
    Output+="// Enabled BufferCacheLazyMemLocking due to virtualization: $virt_used\n"
    Output+="Constants.BufferCacheLazyMemLocking=true\n\n"
fi

Output+="Node.NumNodes=$TotalNodes\n"
ii=0
for i in `seq 0 $(($NumPhysicalNodes - 1))`; do
    for j in `seq 0 $(($NumVirtualNodesPerPhysicalNode - 1))`; do
        Output+="Node.$ii.IpAddr=${PhysicalNodesIpAddr[$i]}\n"
        Output+="Node.$ii.Port=$(($StartPort + $j))\n"
        Output+="Node.$ii.ApiPort=$(($StartApiPort + $j))\n"
        Output+="Node.$ii.MonitorPort=$(($StartMonPort + $j))\n"
        ii=$(($ii + 1))
    done
done
echo -e "$Output" >> $outputCfg

if [ "$outputCfg" != "/dev/stdout" ]; then
    echo "$outputCfg created" >&2
fi
