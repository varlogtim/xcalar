#!/bin/bash


DOCKERPWD=$PWD
SRCDIR=$PWD
DOCKERUSER=$(id -un)

set -e

say () {
    echo >&2 "$*"
}

debug () {
    say "debug: $*"
}

die () {
    say "$*"
    exit 2
}

main () {
    if [ $# -lt 1 ]; then
        say "$0 <path/to/Dockerfile>"
        say 'Converts a Dockerfile into a simple shell script'
        say ''
        say 'Example:'
        say "  $0 Dockerfile > dockerfile.sh && sudo bash dockerfile.sh"
        die ''
    fi
    echo '#!/bin/bash'
    echo '# DO NOT EDIT! THIS FILE IS AUTOGENERATED BY bin/docker2bash.sh!'
    echo '# Make your changes to $XLRDIR/docker/ub14/ub14-build/Dockerfile'
    echo '# and run build config to generate this file and submit it with'
    echo '# your Dockerfile changes'
    echo ''
    echo "DOCKERPWD=\$PWD"
    echo 'DOCKERUSER="`id -un`"'
    echo "SRCDIR=\$PWD"
    echo 'if [ `id -u` -ne 0 ]; then sudo "$0" "$@"; exit $?; fi'
    grep '^ARG' "$1" | sed -Ee 's@ARG (.*)$@if [ -z "\$\1" ]; then echo >\&2 "WARNING: \\\$\1 not specified in the environment!"; fi@g'
    CMD="$(grep '^CMD' "$1" | tr -d '[]' | tr ',' ' ' | sed -e 's@CMD@@g')"
    ENTRYPOINT="$(grep '^ENTRYPOINT' "$1" | tr -d '[]' | tr ',' ' ' | sed -e 's@ENTRYPOINT@@g')"

    echo 'rm -f /etc/profile.d/buildenv.sh'
    echo "set -ex"
    sed ':a;/\\$/{N;s/\\\n\s*//;ba}' "$1" | \
    sed -Ee '/docker_only$/d' | \
    sed -Ee 's@^(ENV|EXPOSE|CMD|ARG|ENTRYPOINT|FROM|MAINTAINER)@# \1@g' | \
    sed -Ee 's@^COPY (.*)$@cd \$SRCDIR \&\& cp \1 \&\& cd - || exit \$?@g' | \
    sed -Ee 's@^ADD (.*)$@cd \$SRCDIR \&\& cp -a \1 \&\& cd - || exit \$?@g' | \
    sed -Ee 's@^RUN (.*)$@cd \$DOCKERPWD \&\& \1 || exit \$?@g' | \
    #sed -Ee 's@^ENV (.*)$@echo export \1 | tee -a /etc/profile.d/buildenv.sh \&\& source /etc/profile.d/buildenv.sh@g' | \
    sed -Ee 's@^WORKDIR (.*)$@DOCKERPWD="\1"@g' | \
    sed -Ee 's@^USER (.*)$@DOCKERUSER="\1"@g'
    echo "#Entrypoint CMD"
    echo "#$ENTRYPOINT $CMD"
}

main "$@"

